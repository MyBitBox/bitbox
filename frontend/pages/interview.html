<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©´ì ‘ ì¤€ë¹„ - BitBox</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="../js/auth.js" defer></script>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Toast UI Editor ì½”ì–´ -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="../index.html">
                    <h1>BitBox</h1>
                </a>
            </div>
            <div class="nav-links">
                <!-- ì—¬ê¸°ëŠ” ë¹„ì›Œë‘¡ë‹ˆë‹¤. JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </nav>
    </header>

    <main class="main">
        <section class="quiz-section">
            <div id="quizContainer">
                <!-- ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í€´ì¦ˆê°€ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 BitBox. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject_id');
        let currentQuizIndex = 0;
        let quizzes = [];

        function displayQuiz(quiz) {
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="quiz-layout">
                    <div class="quiz-main">
                        <div class="quiz-card">
                            <div class="quiz-header">
                                <div class="quiz-progress">
                                    ${currentQuizIndex + 1} / ${quizzes.length}
                                </div>
                                <h2 class="quiz-title">${quiz.title}</h2>
                            </div>
                            <div id="quizContent" class="quiz-content"></div>
                            <div class="interview-answer">
                                <div class="answer-editor" id="answerEditor"></div>
                                <button id="submitAnswer" class="btn btn-primary">ë‹µë³€ ì œì¶œ</button>
                            </div>
                            <div class="quiz-navigation">
                                <button id="nextQuizBtn" class="btn btn-primary">
                                    ë‹¤ìŒ ë¬¸ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="quiz-feedback-section">
                        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                            <div class="spinner"></div>
                            <p>AIê°€ í”¼ë“œë°±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                        <div id="feedbackPlaceholder" class="quiz-feedback-placeholder">
                            <div class="icon">ğŸ¤”</div>
                            <div class="text">
                                <p>ì§ˆë¬¸ì„ ì½ê³  ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
                                <p>AIê°€ ìƒì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div id="quizFeedback" class="quiz-feedback">
                            <h3>AI í”¼ë“œë°±</h3>
                            <div id="feedbackContent"></div>
                        </div>
                    </div>
                </div>
            `;

            // Toast UI Editor ì´ˆê¸°í™” (ë¬¸ì œ ë‚´ìš©)
            new toastui.Editor.factory({
                el: document.getElementById('quizContent'),
                initialValue: quiz.content,
                viewer: true,
                height: 'auto'
            });

            // Toast UI Editor ì´ˆê¸°í™” (ë‹µë³€ ì—ë””í„°)
            const answerEditor = new toastui.Editor({
                el: document.getElementById('answerEditor'),
                height: '300px',
                initialEditType: 'markdown',
                previewStyle: 'vertical',
                placeholder: 'ì—¬ê¸°ì— ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”...'
            });

            // ë‹µë³€ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('submitAnswer').addEventListener('click', async function() {
                const answer = answerEditor.getMarkdown();
                await submitAnswer(quiz.id, answer);
            });

            // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('nextQuizBtn').addEventListener('click', () => {
                if (currentQuizIndex < quizzes.length - 1) {
                    currentQuizIndex++;
                    displayQuiz(quizzes[currentQuizIndex]);
                } else {
                    alert('ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
                    window.location.href = 'subject_list.html';
                }
            });
        }

        async function submitAnswer(quizId, answer) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const feedbackDiv = document.getElementById('quizFeedback');
            const feedbackContent = document.getElementById('feedbackContent');
            const placeholder = document.getElementById('feedbackPlaceholder');

            loadingIndicator.style.display = 'flex';
            feedbackDiv.style.display = 'none';
            placeholder.style.display = 'none';

            try {
                const response = await fetch(`http://localhost:8000/api/quizzes/${quizId}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        content: answer
                    })
                });

                const data = await response.json();

                // í”¼ë“œë°± í‘œì‹œ
                new toastui.Editor.factory({
                    el: feedbackContent,
                    initialValue: data.detail,
                    viewer: true,
                    height: 'auto'
                });
                feedbackDiv.className = `quiz-feedback ${data.is_correct ? 'correct' : 'incorrect'}`;

                loadingIndicator.style.display = 'none';
                feedbackDiv.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                loadingIndicator.style.display = 'none';
                placeholder.style.display = 'flex';
                alert('ë‹µë³€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
        fetch(`http://localhost:8000/api/quizzes?subject_id=${subjectId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                quizzes = data.filter(quiz => quiz.type === 'TEXT');
                if (quizzes.length > 0) {
                    displayQuiz(quizzes[0]);
                } else {
                    document.getElementById('quizContainer').innerHTML = `
                        <div class="error-message">
                            <p>ì•„ì§ ë©´ì ‘ ë¬¸ì œê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                            <p>ë‹¤ë¥¸ ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching quizzes:', error);
                document.getElementById('quizContainer').innerHTML = `
                    <div class="error-message">
                        <p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <p>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            });
    </script>
</body>

</html>