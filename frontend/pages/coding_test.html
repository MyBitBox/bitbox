<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ë”© í…ŒìŠ¤íŠ¸ - BitBox</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="../js/config.js"></script>
    <script src="../js/auth.js" defer></script>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Toast UI Editor ì½”ì–´ -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="../index.html">
                    <h1>BitBox</h1>
                </a>
            </div>
            <div class="nav-links">
                <!-- ì—¬ê¸°ëŠ” ë¹„ì›Œë‘¡ë‹ˆë‹¤. JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </nav>
    </header>

    <main class="main">
        <section class="quiz-section">
            <div id="quizContainer">
                <!-- ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í€´ì¦ˆê°€ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 BitBox. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Monaco Editor ì´ˆê¸°í™”
        require.config({
            paths: {
                vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'
            }
        });
        require(['vs/editor/editor.main'], function() {
            // Monaco Editorê°€ ë¡œë“œëœ í›„ displayQuiz í•¨ìˆ˜ê°€ í˜¸ì¶œë  ìˆ˜ ìˆë„ë¡ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.
            window.monacoLoaded = true;
            if (window.pendingQuizDisplay) {
                displayQuiz(window.pendingQuizDisplay);
            }
        });

        class QuizState {
            constructor() {
                this.currentQuizIndex = 0;
                this.quizzes = [];
                this.answers = new Map(); // ì‚¬ìš©ìì˜ ë‹µë³€ì„ ì €ì¥
                this.feedback = new Map(); // AI í”¼ë“œë°±ì„ ì €ì¥

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœ ë³µì›
                this.restoreState();
            }

            // ìƒíƒœ ì €ì¥
            saveState() {
                const state = {
                    currentQuizIndex: this.currentQuizIndex,
                    answers: Array.from(this.answers.entries()),
                    feedback: Array.from(this.feedback.entries())
                };
                localStorage.setItem(`coding_test_state_${subjectId}`, JSON.stringify(state));
            }

            // ìƒíƒœ ë³µì›
            restoreState() {
                const savedState = localStorage.getItem(`coding_test_state_${subjectId}`);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    this.currentQuizIndex = state.currentQuizIndex;
                    this.answers = new Map(state.answers);
                    this.feedback = new Map(state.feedback);
                }
            }

            // ë‹µë³€ ì €ì¥
            setAnswer(quizId, code) {
                this.answers.set(quizId, code);
                this.saveState();
            }

            // í”¼ë“œë°± ì €ì¥
            setFeedback(quizId, feedback) {
                this.feedback.set(quizId, feedback);
                this.saveState();
            }

            // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
            nextQuiz() {
                if (this.currentQuizIndex < this.quizzes.length - 1) {
                    this.currentQuizIndex++;
                    this.saveState();
                    return true;
                }
                return false;
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject_id');
        const quizState = new QuizState();
        let editor;

        function displayQuiz(quiz) {
            if (!window.monacoLoaded) {
                window.pendingQuizDisplay = quiz;
                return;
            }

            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="quiz-layout">
                    <div class="quiz-main">
                        <div class="quiz-card">
                            <div class="quiz-header">
                                <div class="quiz-progress">
                                    ${quizState.currentQuizIndex + 1} / ${quizState.quizzes.length}
                                </div>
                                <h2 class="quiz-title">${quiz.title}</h2>
                            </div>
                            <div id="quizContent" class="quiz-content"></div>
                            <div class="coding-editor">
                                <div id="codeEditor" style="height: 400px; border: 1px solid #ddd; margin-bottom: 20px;"></div>
                                <div class="button-group" style="display: flex; justify-content: space-between;">
                                    <button id="submitCode" class="btn btn-primary" ${quizState.feedback.has(quiz.id) ? 'disabled' : ''}>
                                        ì½”ë“œ ì œì¶œ
                                    </button>
                                    <button id="nextQuizBtn" class="btn btn-primary" ${quizState.currentQuizIndex >= quizState.quizzes.length - 1 ? 'disabled' : ''}>
                                        ë‹¤ìŒ ë¬¸ì œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="quiz-feedback-section">
                        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                            <div class="spinner"></div>
                            <p>AIê°€ í”¼ë“œë°±ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                        <div id="feedbackPlaceholder" class="quiz-feedback-placeholder"
                             style="display: ${quizState.feedback.has(quiz.id) ? 'none' : 'flex'}">
                            <div class="icon">ğŸ¤”</div>
                            <div class="text">
                                <p>ë¬¸ì œë¥¼ ì½ê³  ì½”ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
                                <p>AIê°€ ìƒì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div id="quizFeedback" class="quiz-feedback"
                             style="display: ${quizState.feedback.has(quiz.id) ? 'block' : 'none'}">
                            <div class="answer-status">
                                ${quizState.feedback.has(quiz.id) ? `
                                    <div class="correctness ${quizState.feedback.get(quiz.id).is_correct ? 'correct' : 'incorrect'}">
                                        ${quizState.feedback.get(quiz.id).is_correct ? 'ì½”ë“œê°€ ì˜ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰' : 'ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤ ğŸ’¡'}
                                    </div>
                                ` : ''}
                            </div>
                            <h3>AI í”¼ë“œë°±</h3>
                            <div id="feedbackContent"></div>
                        </div>
                    </div>
                </div>
            `;

            // Monaco Editor ì´ˆê¸°í™”
            editor = monaco.editor.create(document.getElementById('codeEditor'), {
                value: quizState.answers.get(quiz.id) || '# ì—¬ê¸°ì— ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”',
                language: 'python',
                theme: 'vs',
                minimap: {
                    enabled: false
                },
                automaticLayout: true
            });

            // ë¬¸ì œ ë‚´ìš© í‘œì‹œ
            new toastui.Editor.factory({
                el: document.getElementById('quizContent'),
                initialValue: quiz.content,
                viewer: true,
                height: 'auto'
            });

            // ì €ì¥ëœ í”¼ë“œë°±ì´ ìˆìœ¼ë©´ í‘œì‹œ
            if (quizState.feedback.has(quiz.id)) {
                const feedbackContent = document.getElementById('feedbackContent');
                new toastui.Editor.factory({
                    el: feedbackContent,
                    initialValue: quizState.feedback.get(quiz.id).detail,
                    viewer: true,
                    height: 'auto'
                });
            }

            // ì½”ë“œ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('submitCode').addEventListener('click', async function(e) {
                e.preventDefault();
                if (this.disabled) return;
                
                const code = editor.getValue();
                await handleAnswerSubmission(quiz.id, code);
            });

            // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('nextQuizBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (quizState.nextQuiz()) {
                    displayQuiz(quizState.quizzes[quizState.currentQuizIndex]);
                } else {
                    alert('ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
                    window.location.href = 'subject_list.html';
                }
            });
        }

        async function handleAnswerSubmission(quizId, code) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const feedbackDiv = document.getElementById('quizFeedback');
            const feedbackContent = document.getElementById('feedbackContent');
            const placeholder = document.getElementById('feedbackPlaceholder');
            const submitButton = document.getElementById('submitCode');

            try {
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                submitButton.disabled = true;

                // ë¡œë”© í‘œì‹œ
                loadingIndicator.style.display = 'flex';
                feedbackDiv.style.display = 'none';
                placeholder.style.display = 'none';

                // ë‹µë³€ ì €ì¥
                quizState.setAnswer(quizId, code);

                // API í˜¸ì¶œ
                const response = await fetch(config.getApiUrl(`/api/quizzes/${quizId}/submit`), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        content: code
                    })
                });

                const data = await response.json();
                quizState.setFeedback(quizId, data);

                // í”¼ë“œë°± í‘œì‹œ
                feedbackDiv.style.display = 'block';
                new toastui.Editor.factory({
                    el: feedbackContent,
                    initialValue: data.detail,
                    viewer: true,
                    height: 'auto'
                });

                feedbackDiv.className = `quiz-feedback ${data.is_correct ? 'correct' : 'incorrect'}`;
            } catch (error) {
                console.error('Error:', error);
                alert('ì½”ë“œ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                loadingIndicator.style.display = 'none';
                submitButton.disabled = false;
            }
        }

        // í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
        async function loadQuizzes() {
            try {
                const response = await fetch(config.getApiUrl(`/api/quizzes?subject_id=${subjectId}`), {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    quizState.quizzes = await response.json();
                    if (quizState.quizzes.length > 0) {
                        displayQuiz(quizState.quizzes[quizState.currentQuizIndex]);
                    } else {
                        alert('ì´ ì£¼ì œì— ëŒ€í•œ ì½”ë”© í…ŒìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = 'subject_list.html';
                    }
                } else {
                    throw new Error('ì½”ë”© í…ŒìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('quizContainer').innerHTML = `
                    <div class="error-message">
                        <p>ì½”ë”© í…ŒìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <p>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í€´ì¦ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadQuizzes();
    </script>
</body>

</html>